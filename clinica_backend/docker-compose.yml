version: '3.8'

services:
  # ----------------------------------------------------
  # 1. Base de Datos Documental (MongoDB)
  # ----------------------------------------------------
  mongodb:
    image: mongo:latest
    container_name: mongodb
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: "admin"
      MONGO_INITDB_ROOT_PASSWORD: "adminpassword"
    volumes:
      - mongo-volumen:/data/db
    ports:
      - "27017:27017"
    networks:
      - hcen_network

  # ----------------------------------------------------
  # 2. Base de Datos Relacional (PostgreSQL)
  # ----------------------------------------------------
  db:
    image: postgres:15-alpine
    container_name: periferico-postgres-db
    environment:
      POSTGRES_DB: hcen_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    ports:
      - "5433:5432"
    networks:
      - hcen_network

  # ----------------------------------------------------
  # 3. Servidor de Aplicaciones (WildFly - custom image)
  # ----------------------------------------------------
  wildfly:
    build:
      context: .
      dockerfile: wildfly/Dockerfile
    image: hcen-wildfly-custom:latest
    container_name: hcen-wildfly-app
    
    depends_on:
      db:
        condition: service_healthy 
      mongodb:
        condition: service_started
        
    # Variables de Entorno cruciales para su aplicación Java EE (JWT y MongoDB)
    environment:
      JWT_SECRET_BASE64: "bXlzdXBlcnNlY3JldGtleWZvcmhjZW5qd3R0b2tlbnNzaG91bGRiZWxvbmdlcg=="
      MONGO_HOST: mongodb # Host para la conexión desde Java
      MONGO_PORT: 27017
      MONGO_USER: "admin"
      MONGO_PASSWORD: "adminpassword"
      MONGODB_URI: "mongodb://admin:adminpassword@mongodb:27017/hcen_db?authSource=admin"
      MONGODB_DB: "hcen_db"
      # URL base del nodo periférico para construir URIs de acceso a documentos
      # Desde el backend HCEN se convertirá a hcen-wildfly-app:8080 para acceso interno Docker
      NODO_BASE_URL: "http://localhost:8081"
      # URL del backend HCEN central (para llamadas desde el componente periférico)
      # En Docker, usar el nombre del servicio: hcen-backend:8080
      # Para desarrollo local fuera de Docker, usar http://localhost:8080
      # En producción, configurar con URL del servidor donde corre el backend HCEN
      HCEN_BACKEND_URL: "http://hcen-backend:8080"
      
    volumes:
      # Deploy ONLY the EAR file (not the whole directory to avoid WildFly deploying extracted contents)
      - ./ear/target/hcen.ear:/opt/jboss/wildfly/standalone/deployments/hcen.ear
      - ./wildfly/configure-wildfly.cli:/opt/jboss/wildfly/configure-wildfly.cli
      # Módulos globales persistentes (JWT, Spring Security, MongoDB)
      - ./wildfly-modules/io/jsonwebtoken:/opt/jboss/wildfly/modules/system/layers/base/io/jsonwebtoken:ro
      - ./wildfly-modules/org/springframework:/opt/jboss/wildfly/modules/system/layers/base/org/springframework:ro
      - ./wildfly-modules/org/mongodb:/opt/jboss/wildfly/modules/system/layers/base/org/mongodb:ro
    ports:
      - "8081:8080"
      - "9991:9990"
    networks:
      - hcen_network
      - hcen_backend_network

# Definición de Redes y Volúmenes
networks:
  hcen_network:
    driver: bridge
  hcen_backend_network:
    external: true
    name: hcen_hcen-network

volumes:
  mongo-volumen:
    driver: local