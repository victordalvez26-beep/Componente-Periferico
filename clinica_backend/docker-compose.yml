version: '3.8'

services:
  # ----------------------------------------------------
  # 1. Base de Datos Documental (MongoDB)
  # ----------------------------------------------------
  mongodb:
    image: mongo:latest
    container_name: mongodb
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: "admin"
      MONGO_INITDB_ROOT_PASSWORD: "adminpassword"
    volumes:
      - mongo-volumen:/data/db
    ports:
      - "27017:27017"
    networks:
      - hcen_network

  # ----------------------------------------------------
  # 2. Base de Datos Relacional (PostgreSQL)
  # ----------------------------------------------------
  db:
    image: postgres:15-alpine
    container_name: periferico-postgres-db
    environment:
      POSTGRES_DB: hcen_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    ports:
      - "5433:5432"
    networks:
      - hcen_network

  # ----------------------------------------------------
  # 3. Servidor de Aplicaciones (WildFly - custom image)
  # ----------------------------------------------------
  wildfly:
    build:
      context: .
      dockerfile: wildfly/Dockerfile
    image: hcen-wildfly-custom:latest
    container_name: hcen-wildfly-app
    
    depends_on:
      db:
        condition: service_healthy 
      mongodb:
        condition: service_started
        
    # Variables de Entorno cruciales para su aplicación Java EE (JWT y MongoDB)
    environment:
      JWT_SECRET_BASE64: "bXlzdXBlcnNlY3JldGtleWZvcmhjZW5qd3R0b2tlbnNzaG91bGRiZWxvbmdlcg=="
      MONGO_HOST: mongodb # Host para la conexión desde Java
      MONGO_PORT: 27017
      MONGO_USER: "admin"
      MONGO_PASSWORD: "adminpassword"
      
    volumes:
      # Deploy ONLY the EAR file (not the whole directory to avoid WildFly deploying extracted contents)
      # El nombre del EAR es hcen_clinica.ear según el pom.xml (finalName = ${project.parent.artifactId})
      - ./ear/target/hcen_clinica.ear:/opt/jboss/wildfly/standalone/deployments/hcen_clinica.ear
      - ./wildfly/configure-wildfly.cli:/opt/jboss/wildfly/configure-wildfly.cli
      
    command: 
      /opt/jboss/wildfly/bin/standalone.sh -c standalone.xml --admin-cli --execute=/opt/jboss/wildfly/configure-wildfly.cli
    ports:
      - "8081:8080"
      - "9991:9990"
    networks:
      - hcen_network

# Definición de Redes y Volúmenes
networks:
  hcen_network:
    driver: bridge

volumes:
  mongo-volumen:
    driver: local