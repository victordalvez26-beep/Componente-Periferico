openapi: 3.0.3
info:
  title: Nodo Periférico API (periferico)
  version: 1.0.0
  description: API del nodo periférico — endpoints de autenticación, profesionales y administración de tenants.
servers:
  - url: http://127.0.0.1:8080/hcen-web/api
    description: Servidor local de desarrollo (usar 127.0.0.1 en lugar de localhost)

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
      LoginRequest:
        type: object
        required: [nickname, password]
        properties:
          nickname:
            type: string
            example: admin_c1
          password:
            type: string
            example: password123

      LoginResponse:
        type: object
        properties:
          token:
            type: string
            description: Token JWT bearer
          role:
            type: string
            description: Rol del usuario
        example:
          token: eyJhbGciOiJIUzI1NiJ9... (truncated)
          role: ADMINISTRADOR

      PortalConfiguracion:
        type: object
        properties:
          id:
            type: integer
            format: int64
          colorPrimario:
            type: string
            example: '#007bff'
          colorSecundario:
            type: string
            example: '#6c757d'
          logoUrl:
            type: string
          nombrePortal:
            type: string
            example: 'Clinica Montevideo'

      TenantCreateRequest:
        type: object
        required: [tenantId, nombrePortal]
        properties:
          tenantId:
            type: string
            description: 'Identificador numérico del tenant (sufijo usado en el nombre del esquema, ej: "103")'
            example: '108'
          nombrePortal:
            type: string
            example: 'Clinica Nueva'
          colorPrimario:
            type: string
            example: '#00aa88'

      TenantSummary:
        type: object
        properties:
          id:
            type: integer
          nombre:
            type: string
          rut:
            type: string

      ProfesionalDTO:
        type: object
        properties:
          nombre:
            type: string
          email:
            type: string
            format: email
          nickname:
            type: string
          especialidad:
            type: string
          direccion:
            type: string
          password:
            type: string

      ProfesionalSalud:
        type: object
        properties:
          id:
            type: integer
          nombre:
            type: string
          email:
            type: string
          nickname:
            type: string
          especialidad:
            type: string
          direccion:
            type: string

      ProfesionalResponse:
        type: object
        properties:
          id:
            type: integer
          nombre:
            type: string
          email:
            type: string
          nickname:
            type: string
          especialidad:
            type: string
          direccion:
            type: string

paths:
  /api/auth/login:
    post:
      summary: Iniciar sesión y obtener un JWT
      tags:
        - Autenticación
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Autenticación exitosa. Devuelve token y rol.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '401':
          description: Credenciales inválidas

  /api/auth/logout:
    post:
      summary: Cerrar sesión (el cliente debe descartar el token)
      tags:
        - Autenticación
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Cierre de sesión exitoso
          content:
            application/json:
              example:
                message: "Cierre de sesión exitoso - descartar token en el cliente"

  /api/portal-configuracion/public:
    get:
      summary: Obtener configuración del portal específica del tenant (público)
      tags:
        - Configuración
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Configuración del portal para el tenant resuelta desde el JWT
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PortalConfiguracion'
        '401':
          description: No autorizado o token inválido

  /api/admin/tenants:
    post:
      summary: Crear un nuevo tenant (solo administrador)
      tags:
        - Administración
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TenantCreateRequest'
      responses:
        '201':
          description: Tenant creado (header Location con el id del tenant)
        '400':
          description: Solicitud incorrecta
        '403':
          description: Prohibido (requiere rol ADMINISTRADOR)
        '500':
          description: Error del servidor

    get:
      summary: Listar tenants (solo administrador)
      tags:
        - Administración
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Arreglo de resúmenes de tenants
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TenantSummary'
        '403':
          description: Prohibido

  /api/profesionales:
    get:
      summary: Listar todos los Profesionales (solo administrador)
      tags:
        - Profesionales
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Arreglo de profesionales
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ProfesionalResponse'
        '403':
          description: Prohibido

    post:
      summary: Crear un profesional (solo administrador)
      tags:
        - Profesionales
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProfesionalDTO'
      responses:
        '201':
          description: Profesional creado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProfesionalResponse'
        '400':
          description: Solicitud incorrecta
        '403':
          description: Prohibido

  /api/profesionales/{id}:
    get:
      summary: Obtener profesional por id (solo administrador)
      tags:
        - Profesionales
      security:
        - bearerAuth: []
      parameters:
          - name: id
            in: path
            required: true
            schema:
              type: integer
      responses:
        '200':
          description: Profesional encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProfesionalResponse'
        '404':
          description: No encontrado
        '403':
          description: Prohibido

    put:
      summary: Actualizar profesional (solo administrador)
      tags:
        - Profesionales
      security:
        - bearerAuth: []
      parameters:
          - name: id
            in: path
            required: true
            schema:
              type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProfesionalDTO'
      responses:
        '200':
          description: Profesional actualizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProfesionalResponse'
        '404':
          description: No encontrado
        '403':
          description: Prohibido

    delete:
      summary: Eliminar profesional (solo administrador)
      tags:
        - Profesionales
      security:
        - bearerAuth: []
      parameters:
          - name: id
            in: path
            required: true
            schema:
              type: integer
      responses:
        '204':
          description: Eliminado
        '404':
          description: No encontrado
        '403':
          description: Prohibido
